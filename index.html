<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        .logo_text {
            font-size: 20px;
            font-family: Arial, sans-serif;
            margin: 15px 0;
        }
        .message {
            margin-top: 7px;
        }
        .game_field {
            height: 300px;
            color: cyan;
            background: #ececec;
        }
        .invisible {
            display: none;
        }

        .cont-game {
            width: 100%;
            height: 100%;
            /*background: wheat;*/
        }

        .playing-cards-first-player, .playing-cards-second-player {
            display: flex;
            justify-content: space-around;
            width: 100%;
            height: 35%;
            margin-bottom: 10%;
        }

        .playing-cards-second-player {
            margin-top: 25%;
            margin-bottom: 0;
        }

        .card {
            display: inline-block;
            width: 18%;
            height: 100%;
            border: 1px solid black;
            border-radius: 5px;
            background: darkblue;
        }

        .rotate {
            transition-duration: 1s;
            /*transition: 1000s linear;*/
            transform: rotateY(180deg);
            border: 1px solid black;
            width: 18%;
            border-radius: 5px;
        }

        .card-content {
            visibility: hidden;
            transform: rotateY(180deg);
        }

        .playing-cards-second-player .card {
            background: black;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <h1 class="text-center logo_text">Чат</h1>
        <hr>
    </div>
    <div class="row">
        <div class="col-md-8 col-sm-8">
            <form id='publish' class="form-inline">
                <input type="text" name="nick" class="form-control" placeholder="nick">
                <input type="text" name="message" class="form-control" placeholder="input message">
                <button type="submit" class="btn btn-primary">Отправить</button>
                <button type="button" class="btn btn-ft">Предложить игру</button>
            </form>
            <ul class="messages">

            </ul>
        </div>
        <div class="col-md-4 game_field invisible">
            <div class="cont-game">
                <div class="playing-cards-first-player" id="player-cards">
                    <div class="card" id="card-1">
                        <!--это захардкоженый вариант. потом контент будет генерится через js-->
                        <div class="card-content">
                            <b>offence = </b>100 <br />
                            <b>defence = </b>200
                        </div>
                    </div>
                    <div class="card" id="card-2">
                        <div class="card-content">
                            <b>offence = </b>100 <br />
                            <b>defence = </b>200
                        </div>
                    </div>
                    <div class="card" id="card-3">
                        <div class="card-content">
                            <b>offence = </b>100 <br />
                            <b>defence = </b>200
                        </div>
                    </div>
                    <div class="card" id="card-4">
                        <div class="card-content">
                            <b>offence = </b>100 <br />
                            <b>defence = </b>200
                        </div>
                    </div>
                    <div class="card" id="card-5">
                        <div class="card-content">
                            <b>offence = </b>100 <br />
                            <b>defence = </b>200
                        </div>
                    </div>
                </div>
                <div class="playing-cards-second-player">
                    <div class="card"></div>
                    <div class="card"></div>
                    <div class="card"></div>
                    <div class="card"></div>
                    <div class="card"></div>
                </div>
            </div>
        </div>

    </div>

</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!--<script src="main.js"></script>-->
<script>

    var smiles = {
        ':)'  :  'http://www.kolobok.us/smiles/big_standart/biggrin.gif',
        ':*'  :  'http://www.kolobok.us/smiles/he_and_she/kiss2.gif'
    }
    var url = 'http://chat.apples.fe.a-level.com.ua:8070';
    // var url      = "http://students.a-level.com.ua:10012";
    var ipUrl    = "https://api.ipify.org?format=json";
    var messages = [];

    function jsonPost(url, data, method)
    {
        return new Promise((resolve, reject) => {
            var x = new XMLHttpRequest();

            x.onerror = () => reject(new Error('jsonPost failed'))
            x.open(method || "POST", url, true);
            x.send(JSON.stringify(data))

            x.onreadystatechange = () => {
                if (x.readyState == XMLHttpRequest.DONE && x.status == 200){
                    resolve(JSON.parse(x.responseText))
                }
                else if (x.status != 200){
                    reject(new Error('status is not 200'))
                }
            }
        })
    }

    function addMessage(message, chatField) {
        var messageItem = document.createElement('li');
        messageItem.classList.add('message');
        messageItem.innerHTML = `>> ${message.nick} :  ${findMedia(message.message)}`;
        chatField.appendChild(messageItem);
    }

    function sendMessage(ev) {
        ev.preventDefault();
        var func    = 'addMessage';
        var nick    = this.nick.value;
        var message = this.message.value;
        jsonPost(url, {'func':'addMessage', 'nick': nick, 'message': message}, "POST")

    }

    function findMedia(message) {
        for (var smile in smiles)
            message = message.replaceAll(smile, `<img src="${smiles[smile]}">`)
        return message;
    }

    var interval = setInterval(() => {
        jsonPost(url, {'func' :'getMessages', 'messageId': messages.length}, "POST")
            .then((res) => {
                res.data.forEach(item => {
                    addMessage(item, document.getElementsByClassName('messages')[0])
                    messages.push(item);
                })

            })
    }, 1000)

    function allowFight() {
        if (!localStorage['state']) {
            var data = {};
            data.pk      = generateUUID();
            data.func    = 'addMessage';
            data.action  = 'allowFight';
            data.nick    = this.parentNode.nick.value;
            data.message = `<button data-pk="${generateUUID()}" class="sbm_ft btn btn-success">
                    Принять бой от ${this.parentNode.nick.value}</button>`;
            jsonPost(url, data).
            then((data) => {
                startGame(document.getElementsByClassName('game_field')[0])
                alert('Ваш вызов принял ' + data.opponent )});

        }
    }

    document.getElementById('publish').addEventListener('submit', sendMessage)

    document.getElementsByClassName('btn-ft')[0].addEventListener('click', allowFight)

    document.body.onclick = function(ev) {
        var target = ev.target;
        if (target.classList.contains('sbm_ft') /*&& target.dataset.pk != generateUUID()*/) {

            /* После снятия комментария в блоке if пропадет возможность принимать вызовы у самого себя в одном окне браузера*/

            var data = {};
            data.pk           = generateUUID();
            data.anotherPk    = target.dataset.pk;
            data.action       = 'submitFight';
            data.nick         = document.getElementsByName('nick')[0].value;
            jsonPost(url, data)
                .then((data) => {
                    if (data.status == 'bed') {
                        console.log('##### Ваш соперник уже принимает участие в игре');

                        init();
                    }
                    else
                        alert('Готовьтесь к игре');
                    startGame(document.getElementsByClassName('game_field')[0])
                })
        }
    };







    function doRotate(element) {
        element.classList.add('rotate');
        setTimeout(() => {
            element.children[0].style.visibility = "visible"
        }, 500);
    }

    function init() {
        var cards = document.getElementById('player-cards').children;
        console.log(cards);
        var delay = 200;

        Array.prototype.forEach.call(cards, function(el) {
            setTimeout(function() {
                doRotate(el);
            }, delay);
            delay += 200;
        });
    }











    function generateUUID () {
        var uuid = null;
        if (! localStorage['uuid']) {
            uuid = s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                s4() + '-' + s4() + s4() + s4();
            localStorage['uuid'] = uuid;
            return uuid;
        }
        return localStorage['uuid'];
    }
    function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
    }

    function startGame(field) {
        field.classList.remove('invisible');
    }

    String.prototype.replaceAll = function(str1, str2, ignore) {
        return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(/\$/g,"$$$$"):str2);
    }

</script>

</body>
</html>